<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Monitoreo - Centro de Gobierno</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .sidebar { box-shadow: inset -1px 0 0 rgba(0,0,0,.1); }
        @media (min-width: 768px) {
            .sidebar { position: sticky; top: 0; height: 100vh; overflow-y: auto; }
        }
        .card { border: none; border-radius: 10px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .table th { white-space: nowrap; }
        .chart-container { position: relative; width: 100%; }
        @media (max-width: 767px) { .chart-container { height: 350px; } }
        @media (min-width: 768px) { .chart-container { height: 500px; } }
        #loadingSpinner { display: none; }
        
        /* Colores de texto para sem치foros */
        .text-danger-custom { color: #dc3545 !important; font-weight: bold; }
        .text-warning-custom { color: #d39e00 !important; font-weight: bold; }
        .text-success-custom { color: #198754 !important; font-weight: bold; }
    </style>
</head>
<body>
    <header class="navbar navbar-dark bg-dark sticky-top d-md-none flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="#">游游 Tablero CdG</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </header>

    <div class="container-fluid">
        <div class="row">
            
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse text-white p-3">
                <h4 class="text-center mb-4 d-none d-md-block pt-3">游游 Tablero CdG</h4>
                <hr class="d-none d-md-block">
                
                <div class="mb-4 p-3 bg-secondary bg-opacity-25 rounded border border-secondary" id="manualUploadContainer">
                    <label for="excelFileInput" class="form-label text-white small fw-bold">Carga Manual (Opcional):</label>
                    <input class="form-control form-control-sm" type="file" id="excelFileInput" accept=".xlsx, .xls, .csv">
                </div>

                <h6 class="text-uppercase text-muted mt-4 mb-3 fw-bold">Filtros de Datos</h6>
                
                <div class="mb-3">
                    <label for="ejeFilter" class="form-label small mb-1">Eje:</label>
                    <select id="ejeFilter" class="form-select form-select-sm shadow-sm" onchange="applyFilters()">
                        <option value="Todos">Todos los Ejes</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="ministerioFilter" class="form-label small mb-1">Entidad/Ministerio:</label>
                    <select id="ministerioFilter" class="form-select form-select-sm shadow-sm" onchange="applyFilters()">
                        <option value="Todos">Todas las Entidades</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="intervencionFilter" class="form-label small mb-1">Intervenci칩n:</label>
                    <select id="intervencionFilter" class="form-select form-select-sm shadow-sm" onchange="applyFilters()">
                        <option value="Todas">Todas las Intervenciones</option>
                    </select>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 bg-light min-vh-100">
                
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
                    <h1 class="h2 fw-bold text-dark">Distribuci칩n de Intervenciones</h1>
                    <div id="loadingSpinner" class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="welcomeMessage" class="alert alert-info shadow-sm border-0 border-start border-5 border-info" role="alert">
                    Intentando cargar la matriz de indicadores autom치ticamente...
                </div>

                <div class="row mb-4" id="kpiSection" style="display: none;">
                    <div class="col-12 col-md-4 mb-3">
                        <div class="card text-white bg-primary shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-1 opacity-75">Total Intervenciones Filtradas</h6>
                                <h2 id="kpi-total" class="mb-0 fw-bold display-6">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 mb-3">
                        <div class="card text-white bg-danger shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-1 opacity-75">Alertas Cr칤ticas (Rojo)</h6>
                                <h2 id="kpi-criticos" class="mb-0 fw-bold display-6">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 mb-3">
                        <div class="card text-white bg-success shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-1 opacity-75">Promedio IGP Global</h6>
                                <h2 id="kpi-igp" class="mb-0 fw-bold display-6">0%</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4" id="chartSection" style="display: none;">
                    <div class="col-12 bg-white p-4 rounded shadow-sm">
                        <div class="row mb-4 pb-3 border-bottom g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label small fw-bold text-primary mb-1">Mostrar en el Eje Vertical:</label>
                                <select id="chartDim1" class="form-select form-select-sm" onchange="updateChart()">
                                    <option value="Ministerio(s)">Ministerios/Entidades</option>
                                    <option value="Eje">Ejes</option>
                                    <option value="Intervenci칩n">Intervenciones</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small fw-bold text-success mb-1">Agrupar por Colores:</label>
                                <select id="chartDim2" class="form-select form-select-sm" onchange="updateChart()">
                                    <option value="Eje">Ejes</option>
                                    <option value="Ministerio(s)">Ministerios/Entidades</option>
                                    <option value="Sem치foro IGP">Sem치foro IGP</option>
                                    <option value="Ninguno">Ninguno (Total Unificado)</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded shadow-sm" id="tableSection" style="display: none;">
                    <h5 class="fw-bold mb-3 text-secondary">Detalle Completo de Intervenciones</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered border-light align-middle" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Eje</th>
                                    <th scope="col">Intervenci칩n</th>
                                    <th scope="col">Entidad(es) Involucrada(s)</th>
                                    <th scope="col">Sem치foro IGP</th>
                                    <th scope="col">Acci칩n Requerida</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
            </main>
        </div>
    </div>

    <script>
        let globalData = [];
        let lastFilteredData = []; 
        let chartInstance = null;

        const DEFAULT_FILE_NAME = "./MATRIZ1.xlsx";
        
        const chartColors = [
            '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1',
            '#fd7e14', '#0dcaf0', '#20c997', '#d63384', '#6610f2',
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
        ];

        // 1. CARGA AUTOM츼TICA
        document.addEventListener('DOMContentLoaded', loadDefaultFile);

        async function loadDefaultFile() {
            toggleLoader(true);
            try {
                const url = DEFAULT_FILE_NAME + "?v=" + new Date().getTime();
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                
                processWorkbookData(workbook);
                document.getElementById('manualUploadContainer').style.display = 'none';

            } catch (error) {
                console.warn("Carga autom치tica omitida. Se requiere carga manual.");
                document.getElementById('welcomeMessage').innerHTML = `
                    No se pudo cargar la matriz autom치ticamente (Error: ${error.message}). <br>
                    <strong>Por favor, utiliza el bot칩n "Carga Manual" en el men칰 lateral.</strong>
                `;
            } finally {
                toggleLoader(false);
            }
        }

        // CARGA MANUAL
        document.getElementById('excelFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            toggleLoader(true);
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                processWorkbookData(workbook);
                toggleLoader(false);
            };
            reader.readAsArrayBuffer(file);
        });

        // 2. PROCESAMIENTO EXCEL
        function processWorkbookData(workbook) {
            let sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('proceso')) || workbook.SheetNames[0];
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { range: 3, defval: "" });

            globalData = jsonData.filter(row => row['Eje'] && row['Eje'].toString().trim() !== '');

            if(globalData.length === 0) {
                alert("No se encontraron datos. Verifica la estructura del archivo.");
                return;
            }

            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('kpiSection').style.display = 'flex';
            document.getElementById('chartSection').style.display = 'flex';
            document.getElementById('tableSection').style.display = 'block';

            populateFilters();
            applyFilters();
        }

        function extraerMinisterios(cadena) {
            if (!cadena) return [];
            return cadena.toString().split(/[;/]/).map(item => item.trim()).filter(item => item !== "");
        }

        // B칔SQUEDA INTELIGENTE DE COLUMNAS (ignora saltos de l칤nea en Excel)
        function findColumn(row, keyword) {
            if(!row) return null;
            return Object.keys(row).find(k => k.toLowerCase().includes(keyword.toLowerCase()));
        }

        // 3. FILTROS
        function populateFilters() {
            const ejes = new Set(), ministerios = new Set(), intervenciones = new Set();

            globalData.forEach(row => {
                if (row['Eje']) ejes.add(row['Eje']);
                if (row['Intervenci칩n']) intervenciones.add(row['Intervenci칩n']);
                if (row['Ministerio(s)']) {
                    extraerMinisterios(row['Ministerio(s)']).forEach(min => ministerios.add(min));
                }
            });

            fillSelect('ejeFilter', ejes, 'Todos los Ejes');
            fillSelect('ministerioFilter', ministerios, 'Todas las Entidades');
            fillSelect('intervencionFilter', intervenciones, 'Todas las Intervenciones');
        }

        function fillSelect(elementId, dataSet, defaultText) {
            const select = document.getElementById(elementId);
            select.innerHTML = `<option value="Todos">${defaultText}</option>`;
            Array.from(dataSet).sort().forEach(item => select.add(new Option(item, item)));
        }

        function applyFilters() {
            const ejeSel = document.getElementById('ejeFilter').value;
            const minSel = document.getElementById('ministerioFilter').value;
            const intSel = document.getElementById('intervencionFilter').value;

            lastFilteredData = globalData.filter(row => {
                const matchEje = ejeSel === 'Todos' || row['Eje'] === ejeSel;
                const matchInt = intSel === 'Todas' || row['Intervenci칩n'] === intSel;
                
                const mins = row['Ministerio(s)'] ? extraerMinisterios(row['Ministerio(s)']) : [];
                const matchMin = minSel === 'Todos' || mins.includes(minSel);

                return matchEje && matchMin && matchInt;
            });

            updateKPIs();
            updateTable();
            updateChart();
        }

        // 4. RENDERIZAR INTERFAZ
        function updateKPIs() {
            document.getElementById('kpi-total').innerText = lastFilteredData.length;
            
            if(lastFilteredData.length === 0) return;

            const semaforoKey = findColumn(lastFilteredData[0], 'sem치foro igp') || 'Sem치foro IGP';
            const igpKey = findColumn(lastFilteredData[0], 'igp (%)') || 'IGP (%)';

            let criticos = 0;
            let sumaIGP = 0;
            let conteoIGP = 0;

            lastFilteredData.forEach(row => {
                let sem = (row[semaforoKey] || '').toString().toUpperCase();
                if(sem.includes('ROJO') || sem.includes('CR칈TICO')) criticos++;

                let igpVal = row[igpKey];
                if(igpVal !== undefined && igpVal !== "" && !isNaN(parseFloat(igpVal))) {
                    sumaIGP += parseFloat(igpVal);
                    conteoIGP++;
                }
            });

            document.getElementById('kpi-criticos').innerText = criticos;
            let promedio = conteoIGP === 0 ? 0 : (sumaIGP / conteoIGP).toFixed(1);
            document.getElementById('kpi-igp').innerText = promedio + '%';
        }

        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            
            if(lastFilteredData.length === 0) return;

            const semaforoKey = findColumn(lastFilteredData[0], 'sem치foro igp') || 'Sem치foro IGP';
            const accionKey = findColumn(lastFilteredData[0], 'acci칩n') || 'Acci칩n Requerida';

            lastFilteredData.forEach(row => {
                const tr = document.createElement('tr');
                
                let semText = (row[semaforoKey] || '').toString();
                let semClass = '';
                if(semText.toUpperCase().includes('ROJO') || semText.toUpperCase().includes('CR칈TICO')) semClass = 'text-danger-custom';
                else if(semText.toUpperCase().includes('AMARILLO') || semText.toUpperCase().includes('DESARROLLO')) semClass = 'text-warning-custom';
                else if(semText.toUpperCase().includes('VERDE') || semText.toUpperCase().includes('SATISFACTORIO')) semClass = 'text-success-custom';

                tr.innerHTML = `
                    <td class="fw-medium text-dark">${row['Eje'] || '-'}</td>
                    <td>${row['Intervenci칩n'] || '-'}</td>
                    <td class="text-muted">${row['Ministerio(s)'] || '-'}</td>
                    <td class="${semClass}">${semText || '-'}</td>
                    <td class="small">${row[accionKey] || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getDimValues(row, dimension) {
            if (dimension === 'Ninguno') return ['Total'];
            if (dimension === 'Ministerio(s)') return extraerMinisterios(row['Ministerio(s)']);
            
            // Si la dimensi칩n es Sem치foro IGP, buscamos la columna inteligentemente
            if (dimension === 'Sem치foro IGP') {
                const sKey = findColumn(row, 'sem치foro igp') || 'Sem치foro IGP';
                return row[sKey] ? [row[sKey].toString().trim()] : ['Sin Sem치foro'];
            }
            
            return row[dimension] ? [row[dimension].toString().trim()] : [`Sin ${dimension}`];
        }

        function updateChart() {
            if (!lastFilteredData || lastFilteredData.length === 0) return;

            const ctx = document.getElementById('mainChart').getContext('2d');
            const dim1 = document.getElementById('chartDim1').value; 
            const dim2 = document.getElementById('chartDim2').value; 

            const labelsSet = new Set();
            const conteo = {}; 

            lastFilteredData.forEach(row => {
                const valYArray = getDimValues(row, dim1);
                let valColorArray = getDimValues(row, dim2);
                if (valColorArray.length === 0) valColorArray = ["No definido"];

                valYArray.forEach(valY => {
                    labelsSet.add(valY);
                    valColorArray.forEach(valColor => {
                        if (!conteo[valColor]) conteo[valColor] = {};
                        conteo[valColor][valY] = (conteo[valColor][valY] || 0) + 1;
                    });
                });
            });

            const labelsY = Array.from(labelsSet).sort();
            
            // Asignaci칩n de colores fijos para sem치foros si se agrupa por Sem치foro IGP
            const isSemaforo = dim2 === 'Sem치foro IGP';

            const datasets = Object.keys(conteo).sort().map((grupo, index) => {
                let bgColor = chartColors[index % chartColors.length];
                
                if (isSemaforo) {
                    if (grupo.toUpperCase().includes('ROJO') || grupo.toUpperCase().includes('CR칈TICO')) bgColor = '#dc3545';
                    else if (grupo.toUpperCase().includes('AMARILLO') || grupo.toUpperCase().includes('DESARROLLO')) bgColor = '#ffc107';
                    else if (grupo.toUpperCase().includes('VERDE') || grupo.toUpperCase().includes('SATISFACTORIO')) bgColor = '#198754';
                }

                return {
                    label: grupo,
                    data: labelsY.map(label => conteo[grupo][label] || 0),
                    backgroundColor: bgColor,
                    borderWidth: 1,
                    borderRadius: 4 
                };
            });

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labelsY, datasets: datasets },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { position: 'top', display: (dim2 !== 'Ninguno') },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } },
                        y: { stacked: true }
                    }
                }
            });
        }

        function toggleLoader(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'inline-block' : 'none';
        }
    </script>
</body>
</html>

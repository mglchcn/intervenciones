<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Monitoreo - Centro de Gobierno</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .sidebar { position: sticky; top: 0; height: 100vh; box-shadow: inset -1px 0 0 rgba(0,0,0,.1); }
        .card { border: none; border-radius: 10px; }
        .table th { white-space: nowrap; }
        .chart-container { position: relative; height: 500px; width: 100%; }
        /* Animaci贸n de carga */
        #loadingSpinner { display: none; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar text-white p-3 min-vh-100">
                <h4 class="text-center mb-4">ю Tablero CdG</h4>
                <hr>
                
                <div class="mb-4 p-2 bg-secondary rounded" id="manualUploadContainer">
                    <label for="excelFileInput" class="form-label text-white small fw-bold">Carga Manual (Opcional):</label>
                    <input class="form-control form-control-sm" type="file" id="excelFileInput" accept=".xlsx, .xls, .csv">
                </div>

                <h6 class="text-uppercase text-muted mt-4 mb-2">Filtros de Datos</h6>
                <div class="mb-3">
                    <label for="ejeFilter" class="form-label small">Eje:</label>
                    <select id="ejeFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todos">Todos los Ejes</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="ministerioFilter" class="form-label small">Entidad/Ministerio:</label>
                    <select id="ministerioFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todos">Todas las Entidades</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="intervencionFilter" class="form-label small">Intervenci贸n:</label>
                    <select id="intervencionFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todas">Todas las Intervenciones</option>
                    </select>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 bg-light">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                    <h1 class="h2">Distribuci贸n de Intervenciones</h1>
                    
                    <div id="loadingSpinner" class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="welcomeMessage" class="alert alert-info shadow-sm" role="alert">
                    Intentando cargar la matriz de indicadores autom谩ticamente... Si no sucede nada, utiliza el bot贸n de carga manual en el men煤 lateral.
                </div>

                <div class="row mb-4" id="kpiSection" style="display: none;">
                    <div class="col-md-4">
                        <div class="card text-white bg-primary shadow-sm">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-0">Total Intervenciones Filtradas</h6>
                                <h2 id="kpi-total" class="mb-0">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4" id="chartSection" style="display: none;">
                    <div class="col-md-12 bg-white p-3 rounded shadow-sm">
                        <div class="row mb-3 pb-3 border-bottom">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-primary">Mostrar en el Eje Vertical:</label>
                                <select id="chartDim1" class="form-select form-select-sm" onchange="updateChart()">
                                    <option value="Eje">Ejes</option>
                                    <option value="Ministerio(s)">Ministerios/Entidades</option>
                                    <option value="Intervenci贸n">Intervenciones</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold text-success">Agrupar por Colores:</label>
                                <select id="chartDim2" class="form-select form-select-sm" onchange="updateChart()">
                                    <option value="Ministerio(s)">Ministerios/Entidades</option>
                                    <option value="Eje">Ejes</option>
                                    <option value="Ninguno">Ninguno (Total Unificado)</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 rounded shadow-sm" id="tableSection" style="display: none;">
                    <h5>Detalle de Intervenciones</h5>
                    <div class="table-responsive mt-3">
                        <table class="table table-striped table-hover table-sm" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Eje</th>
                                    <th>Intervenci贸n</th>
                                    <th>Entidad(es) Involucrada(s)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let globalData = [];
        let lastFilteredData = []; 
        let chartInstance = null;

        // Nombre exacto del archivo que buscar谩 autom谩ticamente
        const DEFAULT_FILE_NAME = "MATRIZ1.xlsx";

        const chartColors = [
            '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1',
            '#fd7e14', '#0dcaf0', '#20c997', '#d63384', '#6610f2',
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
        ];

        // 1. INTENTAR CARGAR AUTOMTICAMENTE AL INICIAR
        document.addEventListener('DOMContentLoaded', () => {
            loadDefaultFile();
        });

        async function loadDefaultFile() {
            document.getElementById('loadingSpinner').style.display = 'block';
            try {
                const response = await fetch(DEFAULT_FILE_NAME);
                if (!response.ok) throw new Error("Archivo no encontrado o acceso bloqueado por CORS");
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                
                processWorkbookData(workbook);
                
                // Ocultar secci贸n de carga manual si el autom谩tico funcion贸
                document.getElementById('manualUploadContainer').style.display = 'none';

            } catch (error) {
                console.warn("Carga autom谩tica omitida. Motivo: Ejecuci贸n local (doble clic) o archivo no encontrado. Se requiere carga manual.");
                document.getElementById('welcomeMessage').innerHTML = `
                    No se pudo cargar la matriz autom谩ticamente (posible bloqueo de seguridad del navegador). <br>
                    <strong>Por favor, utiliza el bot贸n "Carga Manual" en el men煤 de la izquierda para seleccionar tu archivo Excel.</strong>
                `;
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // 2. EVENTO DE CARGA MANUAL (Fallback)
        document.getElementById('excelFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('loadingSpinner').style.display = 'block';
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    processWorkbookData(workbook);
                    document.getElementById('loadingSpinner').style.display = 'none';
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // 3. PROCESAMIENTO CENTRALIZADO DEL EXCEL
        function processWorkbookData(workbook) {
            let sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('proceso'));
            if (!sheetName) sheetName = workbook.SheetNames[0];

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 3, defval: "" });

            globalData = jsonData.filter(row => row['Eje'] && row['Eje'].toString().trim() !== '');

            if(globalData.length === 0) {
                alert("No se encontraron datos. Verifica la estructura de la Matriz.");
                return;
            }

            // Mostrar el dashboard
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('kpiSection').style.display = 'flex';
            document.getElementById('chartSection').style.display = 'flex';
            document.getElementById('tableSection').style.display = 'block';

            populateFilters();
            applyFilters();
        }

        function extraerMinisterios(cadena) {
            if (!cadena) return [];
            return cadena.toString().split(/[;/]/).map(item => item.trim()).filter(item => item !== "");
        }

        function populateFilters() {
            const ejeSet = new Set();
            const minSet = new Set();
            const intSet = new Set();

            globalData.forEach(row => {
                if (row['Eje']) ejeSet.add(row['Eje']);
                if (row['Intervenci贸n']) intSet.add(row['Intervenci贸n']);
                if (row['Ministerio(s)']) {
                    const ministerios = extraerMinisterios(row['Ministerio(s)']);
                    ministerios.forEach(min => minSet.add(min));
                }
            });

            const ejeSelect = document.getElementById('ejeFilter');
            ejeSelect.innerHTML = '<option value="Todos">Todos los Ejes</option>';
            Array.from(ejeSet).sort().forEach(eje => ejeSelect.add(new Option(eje, eje)));

            const minSelect = document.getElementById('ministerioFilter');
            minSelect.innerHTML = '<option value="Todos">Todas las Entidades</option>';
            Array.from(minSet).sort().forEach(min => minSelect.add(new Option(min, min)));

            const intSelect = document.getElementById('intervencionFilter');
            intSelect.innerHTML = '<option value="Todas">Todas las Intervenciones</option>';
            Array.from(intSet).sort().forEach(intv => intSelect.add(new Option(intv, intv)));
        }

        function applyFilters() {
            const ejeSelected = document.getElementById('ejeFilter').value;
            const minSelected = document.getElementById('ministerioFilter').value;
            const intSelected = document.getElementById('intervencionFilter').value;

            lastFilteredData = globalData.filter(row => {
                const matchEje = ejeSelected === 'Todos' || row['Eje'] === ejeSelected;
                const matchInt = intSelected === 'Todas' || row['Intervenci贸n'] === intSelected;
                
                let matchMin = false;
                if (minSelected === 'Todos') {
                    matchMin = true;
                } else if (row['Ministerio(s)']) {
                    const ministeriosDeLaFila = extraerMinisterios(row['Ministerio(s)']);
                    matchMin = ministeriosDeLaFila.includes(minSelected);
                }

                return matchEje && matchMin && matchInt;
            });

            document.getElementById('kpi-total').innerText = lastFilteredData.length;
            updateTable();
            updateChart();
        }

        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            lastFilteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Eje'] || '-'}</td>
                    <td>${row['Intervenci贸n'] || '-'}</td>
                    <td>${row['Ministerio(s)'] || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getDimValues(row, dimension) {
            if (dimension === 'Ninguno') return ['Total'];
            if (dimension === 'Ministerio(s)') return extraerMinisterios(row['Ministerio(s)']);
            let valor = row[dimension];
            return valor ? [valor.toString().trim()] : ['Sin ' + dimension];
        }

        function updateChart() {
            if (!lastFilteredData || lastFilteredData.length === 0) return;

            const ctx = document.getElementById('mainChart').getContext('2d');
            const dim1 = document.getElementById('chartDim1').value; 
            const dim2 = document.getElementById('chartDim2').value; 

            let labelsSet = new Set();
            let conteo = {}; 

            lastFilteredData.forEach(row => {
                const valoresEjeY = getDimValues(row, dim1);
                let valoresColor = getDimValues(row, dim2);
                
                if (valoresColor.length === 0) valoresColor = ["No definido"];

                valoresEjeY.forEach(valY => {
                    labelsSet.add(valY);
                    valoresColor.forEach(valColor => {
                        if (!conteo[valColor]) conteo[valColor] = {};
                        if (!conteo[valColor][valY]) conteo[valColor][valY] = 0;
                        conteo[valColor][valY]++;
                    });
                });
            });

            const labelsY = Array.from(labelsSet).sort();
            const gruposColor = Object.keys(conteo).sort();
            
            const datasets = gruposColor.map((grupo, index) => {
                return {
                    label: grupo,
                    data: labelsY.map(label => conteo[grupo][label] || 0),
                    backgroundColor: chartColors[index % chartColors.length],
                    borderWidth: 1
                };
            });

            if (chartInstance) {
                chartInstance.destroy();
            }

            const showLegend = (dim2 !== 'Ninguno');

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsY,
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { position: 'top', display: showLegend },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } },
                        y: { stacked: true }
                    }
                }
            });
        }
    </script>
</body>
</html>


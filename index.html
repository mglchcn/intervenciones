<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Plataforma de Monitoreo - Centro de Gobierno de Bolivia">
    <title>Plataforma de Monitoreo - Centro de Gobierno</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ============================================
           VARIABLES CSS
           ============================================ */
        :root {
            --primary-dark: #1a252f;
            --primary-light: #2c3e50;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --bg-light: #f4f7f6;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
            --card-shadow-hover: 0 8px 15px rgba(0,0,0,0.1);
            --transition-speed: 0.3s;
        }

        /* ============================================
           ESTILOS BASE
           ============================================ */
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ============================================
           SIDEBAR
           ============================================ */
        .sidebar { 
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            min-height: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: all var(--transition-speed) ease;
        }

        @media (min-width: 768px) {
            .sidebar { 
                position: sticky; 
                top: 0; 
                height: 100vh;
                overflow-y: auto;
            }
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        /* ============================================
           TARJETAS
           ============================================ */
        .card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: var(--card-shadow);
            transition: box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease;
        }

        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }

        /* ============================================
           CONTENEDORES
           ============================================ */
        .chart-container { 
            position: relative; 
            height: 65vh; 
            min-height: 450px;
            width: 100%;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: var(--card-shadow);
        }

        /* ============================================
           TEXTOS
           ============================================ */
        .small-text { 
            font-size: 0.85rem; 
        }

        .text-gradient {
            background: linear-gradient(135deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ============================================
           FORMULARIOS Y CONTROLES
           ============================================ */
        .form-select, .form-control {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all var(--transition-speed) ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.15);
        }

        /* ============================================
           LOADING SPINNER
           ============================================ */
        #loadingSpinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255,255,255,0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* ============================================
           ALERTAS Y NOTIFICACIONES
           ============================================ */
        .alert {
            border-radius: 10px;
            border: none;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        /* ============================================
           ANIMACIONES
           ============================================ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* ============================================
           TABLA
           ============================================ */
        .table {
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 2px solid var(--accent-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: background-color var(--transition-speed) ease;
        }

        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* ============================================
           KPI CARDS
           ============================================ */
        .kpi-card {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            box-shadow: var(--card-shadow);
            transition: transform var(--transition-speed) ease;
        }

        .kpi-card:hover {
            transform: scale(1.02);
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .chart-container {
                height: 50vh;
                min-height: 300px;
            }
            
            .sidebar {
                position: relative;
                height: auto;
            }
            
            .table-container {
                padding: 1rem;
            }
        }

        /* ============================================
           UTILIDADES
           ============================================ */
        .badge-custom {
            padding: 0.5em 0.8em;
            border-radius: 6px;
            font-weight: 500;
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1), transparent);
            margin: 1.5rem 0;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Toast Container para notificaciones -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="d-none">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-center fw-bold">Procesando datos...</p>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar text-white p-4" role="navigation" aria-label="Men煤 principal">
                <div class="text-center mb-4">
                    <h5 class="fw-bold">ю Tablero CdG</h5>
                    <p class="text-white-50 small">Monitoreo de Gesti贸n</p>
                </div>
                <hr class="opacity-25">
                
                <!-- Carga Manual -->
                <div id="manualUploadContainer" class="mb-4 p-3 bg-white bg-opacity-10 rounded">
                    <label for="excelFileInput" class="form-label small fw-bold">
                        <i class="bi bi-upload"></i> Carga Manual:
                    </label>
                    <input 
                        class="form-control form-control-sm" 
                        type="file" 
                        id="excelFileInput" 
                        accept=".xlsx, .xls, .csv"
                        aria-label="Seleccionar archivo Excel"
                    >
                    <small class="text-white-50 d-block mt-2">Formatos: .xlsx, .xls, .csv</small>
                </div>

                <!-- Filtros -->
                <h6 class="text-uppercase text-white-50 small fw-bold mt-4 mb-3">
                    <i class="bi bi-funnel"></i> Filtros Activos
                </h6>
                
                <div class="mb-3">
                    <label for="ejeFilter" class="form-label small-text">Filtrar por Eje:</label>
                    <select id="ejeFilter" class="form-select form-select-sm" aria-label="Filtrar por eje estrat茅gico">
                        <option value="Todos">Todos los Ejes</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="ministerioFilter" class="form-label small-text">Filtrar por Entidad:</label>
                    <select id="ministerioFilter" class="form-select form-select-sm" aria-label="Filtrar por entidad/ministerio">
                        <option value="Todos">Todas las Entidades</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="intervencionFilter" class="form-label small-text">Intervenci贸n Espec铆fica:</label>
                    <select id="intervencionFilter" class="form-select form-select-sm" aria-label="Filtrar por intervenci贸n">
                        <option value="Todas">Todas las Intervenciones</option>
                    </select>
                </div>

                <!-- Bot贸n de reset -->
                <button 
                    id="resetFiltersBtn" 
                    class="btn btn-outline-light btn-sm w-100 mt-3"
                    onclick="resetFilters()"
                >
                    <i class="bi bi-arrow-counterclockwise"></i> Resetear Filtros
                </button>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4" role="main">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center pb-3 mb-4 border-bottom">
                    <div>
                        <h2 class="h4 fw-bold text-dark mb-0">Distribuci贸n de Intervenciones</h2>
                        <p class="text-muted small mb-0">An谩lisis y visualizaci贸n de datos de gesti贸n</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <span id="lastUpdate" class="text-muted small"></span>
                        <button 
                            class="btn btn-primary btn-sm"
                            onclick="exportData()"
                            id="exportBtn"
                            disabled
                        >
                            <i class="bi bi-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Welcome Message -->
                <div id="welcomeMessage" class="alert alert-info border shadow-sm fade-in" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <div>
                            <strong>Intentando conectar con MATRIZ1.xlsx...</strong>
                            <p class="mb-0 small">Por favor espere mientras cargamos los datos.</p>
                        </div>
                    </div>
                </div>

                <!-- KPI Section -->
                <div class="row g-3 mb-4" id="kpiSection" style="display: none;">
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="kpi-card">
                            <span class="small-text opacity-75">Resultados bajo filtros</span>
                            <h2 id="kpi-total" class="fw-bold mb-0">0</h2>
                            <small class="opacity-75">Registros encontrados</small>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <span class="small-text text-muted">Ejes nicos</span>
                                <h3 id="kpi-ejes" class="fw-bold mb-0 text-primary">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <span class="small-text text-muted">Entidades nicas</span>
                                <h3 id="kpi-entidades" class="fw-bold mb-0 text-success">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="row" id="chartSection" style="display: none;">
                    <div class="col-12">
                        <div class="card p-3 p-md-4">
                            <div class="row g-3 mb-4 align-items-end">
                                <div class="col-12 col-md-5">
                                    <label class="form-label small fw-bold text-secondary" for="chartDim1">
                                        <i class="bi bi-bar-chart"></i> Ver en el Eje Y:
                                    </label>
                                    <select id="chartDim1" class="form-select" aria-label="Seleccionar dimensi贸n para eje Y">
                                        <option value="Auto">Auto (Ajuste seg煤n Filtro)</option>
                                        <option value="Eje">Ejes Estrat茅gicos</option>
                                        <option value="Ministerio(s)">Entidades/Ministerios</option>
                                        <option value="Intervenci贸n">Nombre de Intervenci贸n</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-5">
                                    <label class="form-label small fw-bold text-secondary" for="chartDim2">
                                        <i class="bi bi-palette"></i> Colores por:
                                    </label>
                                    <select id="chartDim2" class="form-select" aria-label="Seleccionar dimensi贸n para colores">
                                        <option value="Auto">Auto (Ajuste seg煤n Filtro)</option>
                                        <option value="Ministerio(s)">Entidades</option>
                                        <option value="Eje">Ejes</option>
                                        <option value="Ninguno">Unificado (Sin agrupaci贸n)</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-2">
                                    <button 
                                        class="btn btn-outline-secondary w-100"
                                        onclick="refreshChart()"
                                    >
                                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="mainChart" aria-label="Gr谩fico de intervenciones" role="img"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Section -->
                <div class="table-container shadow-sm" id="tableSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0 text-dark">
                            <i class="bi bi-table"></i> Detalle de Registros Filtrados
                        </h5>
                        <div class="d-flex gap-2">
                            <input 
                                type="text" 
                                id="tableSearch" 
                                class="form-control form-control-sm" 
                                placeholder="Buscar en tabla..."
                                style="width: 200px;"
                                oninput="searchTable()"
                            >
                            <span class="badge bg-secondary align-self-center" id="tableCount">0 registros</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="dataTable">
                            <thead class="table-light">
                                <tr class="small-text text-uppercase">
                                    <th scope="col">#</th>
                                    <th scope="col">Eje</th>
                                    <th scope="col">Intervenci贸n</th>
                                    <th scope="col">Entidad</th>
                                </tr>
                            </thead>
                            <tbody class="small-text"></tbody>
                        </table>
                    </div>
                    <!-- Paginaci贸n -->
                    <nav aria-label="Paginaci贸n de tabla" class="mt-3">
                        <ul class="pagination justify-content-center" id="tablePagination"></ul>
                    </nav>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <script>
        /**
         * ============================================
         * PLATAFORMA DE MONITOREO - CENTRO DE GOBIERNO
         * ============================================
         * 
         * M贸dulo principal de la aplicaci贸n
         * Maneja la carga, procesamiento y visualizaci贸n de datos
         * 
         * @author SuperNinja
         * @version 2.0.0
         */

        // ============================================
        // CONFIGURACIN GLOBAL
        // ============================================
        const CONFIG = {
            DEFAULT_FILE_NAME: "./MATRIZ1.xlsx",
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            DEBOUNCE_DELAY: 300,
            ITEMS_PER_PAGE: 50,
            CHART_COLORS: [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
                '#6610f2', '#fd7e14', '#20c997', '#d63384', '#6f42c1',
                '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0'
            ]
        };

        // ============================================
        // ESTADO DE LA APLICACIN
        // ============================================
        const AppState = {
            globalData: [],
            filteredData: [],
            chartInstance: null,
            currentPage: 1,
            isProcessing: false
        };

        // ============================================
        // UTILIDADES
        // ============================================
        
        /**
         * Muestra una notificaci贸n toast
         * @param {string} message - Mensaje a mostrar
         * @param {string} type - Tipo de notificaci贸n (success, error, warning, info)
         */
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = `toast-${Date.now()}`;
            
            const bgClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-info';

            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        /**
         * Funci贸n debounce para optimizar rendimiento
         * @param {Function} func - Funci贸n a ejecutar
         * @param {number} wait - Tiempo de espera en ms
         * @returns {Function} Funci贸n con debounce
         */
        function debounce(func, wait = CONFIG.DEBOUNCE_DELAY) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Extrae ministerios de una cadena
         * @param {string} cadena - Cadena con ministerios separados
         * @returns {Array} Array de ministerios
         */
        function extraerMinisterios(cadena) {
            if (!cadena) return [];
            return cadena
                .toString()
                .split(/[;/,]/)
                .map(item => item.trim())
                .filter(item => item !== "");
        }

        /**
         * Valida el archivo cargado
         * @param {File} file - Archivo a validar
         * @returns {Object} Objeto con validaci贸n y mensaje de error
         */
        function validateFile(file) {
            if (!file) {
                return { valid: false, error: 'No se ha seleccionado ning煤n archivo' };
            }
            
            const validExtensions = ['.xlsx', '.xls', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                return { 
                    valid: false, 
                    error: `Formato no v谩lido. Se permiten: ${validExtensions.join(', ')}` 
                };
            }
            
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                return { 
                    valid: false, 
                    error: `El archivo excede el tama帽o m谩ximo de ${CONFIG.MAX_FILE_SIZE / 1024 / 1024}MB` 
                };
            }
            
            return { valid: true };
        }

        /**
         * Muestra/oculta el spinner de carga
         * @param {boolean} show - Mostrar u ocultar
         */
        function toggleLoadingSpinner(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('d-none');
                AppState.isProcessing = true;
            } else {
                spinner.classList.add('d-none');
                AppState.isProcessing = false;
            }
        }

        // ============================================
        // MANEJO DE DATOS
        // ============================================

        /**
         * Carga el archivo por defecto
         */
        async function loadDefaultFile() {
            try {
                toggleLoadingSpinner(true);
                
                const response = await fetch(CONFIG.DEFAULT_FILE_NAME);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo cargar el archivo`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                
                processWorkbookData(workbook);
                
                document.getElementById('manualUploadContainer').style.display = 'none';
                showToast('Archivo cargado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error cargando archivo por defecto:', error);
                document.getElementById('welcomeMessage').innerHTML = `
                    <div class="alert alert-warning mb-0 small">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Carga autom谩tica no disponible.</strong><br>
                        Por favor, sube el archivo manualmente usando el formulario en la barra lateral.
                        <br><small class="text-muted">Error: ${error.message}</small>
                    </div>
                `;
                showToast('No se pudo cargar el archivo autom谩ticamente', 'warning');
            } finally {
                toggleLoadingSpinner(false);
            }
        }

        /**
         * Procesa los datos del workbook de Excel
         * @param {Object} workbook - Workbook de SheetJS
         */
        function processWorkbookData(workbook) {
            try {
                // Buscar la hoja de procesos
                let sheetName = workbook.SheetNames.find(n => 
                    n.toLowerCase().includes('proceso')
                ) || workbook.SheetNames[0];
                
                const sheet = workbook.Sheets[sheetName];
                
                // Convertir a JSON, saltando las primeras 3 filas (encabezados)
                const rawData = XLSX.utils.sheet_to_json(sheet, { 
                    range: 3, 
                    defval: "" 
                });
                
                // Filtrar filas v谩lidas
                AppState.globalData = rawData.filter(row => {
                    const eje = row['Eje'];
                    return eje && eje.toString().trim() !== '';
                });
                
                if (AppState.globalData.length === 0) {
                    throw new Error('No se encontraron datos v谩lidos en el archivo');
                }
                
                // Actualizar UI
                document.getElementById('welcomeMessage').style.display = 'none';
                document.querySelectorAll('#kpiSection, #chartSection, #tableSection').forEach(el => {
                    el.style.display = 'flex';
                    el.classList.add('fade-in');
                });
                
                if (window.innerWidth < 768) {
                    document.getElementById('tableSection').style.display = 'block';
                }
                
                // Habilitar exportaci贸n
                document.getElementById('exportBtn').disabled = false;
                
                // Actualizar timestamp
                document.getElementById('lastUpdate').textContent = 
                    `ltima actualizaci贸n: ${new Date().toLocaleTimeString()}`;
                
                // Inicializar filtros y aplicar
                populateFilters();
                applyFilters();
                
                showToast(`Se cargaron ${AppState.globalData.length} registros`, 'success');
                
            } catch (error) {
                console.error('Error procesando workbook:', error);
                showToast(`Error procesando datos: ${error.message}`, 'error');
                throw error;
            }
        }

        // ============================================
        // FILTROS
        // ============================================

        /**
         * Pobla los selectores de filtros con los datos disponibles
         */
        function populateFilters() {
            const sets = {
                eje: new Set(),
                min: new Set(),
                int: new Set()
            };
            
            // Recopilar valores 煤nicos
            AppState.globalData.forEach(row => {
                if (row['Eje']) sets.eje.add(row['Eje']);
                if (row['Intervenci贸n']) sets.int.add(row['Intervenci贸n']);
                
                const ministerios = extraerMinisterios(row['Ministerio(s)']);
                ministerios.forEach(m => sets.min.add(m));
            });
            
            // Funci贸n auxiliar para llenar selectores
            const fillSelect = (id, set, defaultText) => {
                const select = document.getElementById(id);
                const defaultValue = id === 'intervencionFilter' ? 'Todas' : 'Todos';
                
                select.innerHTML = `<option value="${defaultValue}">${defaultText}</option>`;
                
                Array.from(set)
                    .sort()
                    .forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        select.appendChild(option);
                    });
            };
            
            fillSelect('ejeFilter', sets.eje, 'Todos los Ejes');
            fillSelect('ministerioFilter', sets.min, 'Todas las Entidades');
            fillSelect('intervencionFilter', sets.int, 'Todas las Intervenciones');
        }

        /**
         * Aplica los filtros seleccionados a los datos
         */
        function applyFilters() {
            if (AppState.isProcessing) return;
            
            const fEje = document.getElementById('ejeFilter').value;
            const fMin = document.getElementById('ministerioFilter').value;
            const fInt = document.getElementById('intervencionFilter').value;
            
            AppState.filteredData = AppState.globalData.filter(row => {
                const matchEje = fEje === 'Todos' || row['Eje'] === fEje;
                const matchInt = fInt === 'Todas' || row['Intervenci贸n'] === fInt;
                const matchMin = fMin === 'Todos' || 
                    extraerMinisterios(row['Ministerio(s)']).includes(fMin);
                
                return matchEje && matchInt && matchMin;
            });
            
            // Actualizar KPIs
            updateKPIs();
            
            // Actualizar tabla y gr谩fico
            updateTable();
            updateChart();
        }

        /**
         * Resetea todos los filtros a su estado inicial
         */
        function resetFilters() {
            document.getElementById('ejeFilter').value = 'Todos';
            document.getElementById('ministerioFilter').value = 'Todos';
            document.getElementById('intervencionFilter').value = 'Todas';
            document.getElementById('chartDim1').value = 'Auto';
            document.getElementById('chartDim2').value = 'Auto';
            
            applyFilters();
            showToast('Filtros reseteados', 'info');
        }

        // ============================================
        // KPIs
        // ============================================

        /**
         * Actualiza los indicadores clave de rendimiento
         */
        function updateKPIs() {
            const total = AppState.filteredData.length;
            
            // Calcular ejes 煤nicos
            const ejesUnicos = new Set(AppState.filteredData.map(row => row['Eje'])).size;
            
            // Calcular entidades 煤nicas
            const entidadesUnicas = new Set();
            AppState.filteredData.forEach(row => {
                extraerMinisterios(row['Ministerio(s)']).forEach(m => entidadesUnicas.add(m));
            });
            
            // Animar contadores
            animateCounter('kpi-total', total);
            animateCounter('kpi-ejes', ejesUnicos);
            animateCounter('kpi-entidades', entidadesUnicas.size);
        }

        /**
         * Anima un contador num茅rico
         * @param {string} elementId - ID del elemento
         * @param {number} targetValue - Valor objetivo
         */
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = parseInt(element.textContent) || 0;
            const duration = 500;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuart);
                
                element.textContent = currentValue.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // ============================================
        // TABLA
        // ============================================

        /**
         * Actualiza la tabla con los datos filtrados
         */
        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            const startIndex = (AppState.currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
            const endIndex = startIndex + CONFIG.ITEMS_PER_PAGE;
            const pageData = AppState.filteredData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No se encontraron registros
                        </td>
                    </tr>
                `;
                document.getElementById('tableCount').textContent = '0 registros';
                return;
            }
            
            tbody.innerHTML = pageData.map((row, index) => `
                <tr>
                    <td class="fw-medium text-muted">${startIndex + index + 1}</td>
                    <td class="fw-medium">
                        <span class="badge bg-primary badge-custom">${row['Eje']}</span>
                    </td>
                    <td>${row['Intervenci贸n']}</td>
                    <td class="text-secondary small">${row['Ministerio(s)']}</td>
                </tr>
            `).join('');
            
            // Actualizar contador
            document.getElementById('tableCount').textContent = 
                `${AppState.filteredData.length} registros`;
            
            // Actualizar paginaci贸n
            updatePagination();
        }

        /**
         * Actualiza la paginaci贸n de la tabla
         */
        function updatePagination() {
            const totalPages = Math.ceil(AppState.filteredData.length / CONFIG.ITEMS_PER_PAGE);
            const pagination = document.getElementById('tablePagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Bot贸n anterior
            html += `
                <li class="page-item ${AppState.currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${AppState.currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // P谩ginas
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= AppState.currentPage - 1 && i <= AppState.currentPage + 1)) {
                    html += `
                        <li class="page-item ${i === AppState.currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === AppState.currentPage - 2 || i === AppState.currentPage + 2) {
                    html += '<li class="page-item disabled"><a class="page-link">...</a></li>';
                }
            }
            
            // Bot贸n siguiente
            html += `
                <li class="page-item ${AppState.currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${AppState.currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = html;
        }

        /**
         * Cambia la p谩gina actual de la tabla
         * @param {number} page - N煤mero de p谩gina
         */
        function changePage(page) {
            const totalPages = Math.ceil(AppState.filteredData.length / CONFIG.ITEMS_PER_PAGE);
            
            if (page < 1 || page > totalPages) return;
            
            AppState.currentPage = page;
            updateTable();
        }

        /**
         * Busca en la tabla
         */
        function searchTable() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            
            if (!searchTerm) {
                AppState.filteredData = [...AppState.globalData];
            } else {
                AppState.filteredData = AppState.globalData.filter(row => {
                    return Object.values(row).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            AppState.currentPage = 1;
            updateTable();
            updateKPIs();
        }

        // ============================================
        // GRFICO
        // ============================================

        /**
         * Actualiza el gr谩fico con los datos filtrados
         */
        function updateChart() {
            if (AppState.filteredData.length === 0) {
                if (AppState.chartInstance) {
                    AppState.chartInstance.destroy();
                    AppState.chartInstance = null;
                }
                return;
            }
            
            const fEje = document.getElementById('ejeFilter').value;
            const fMin = document.getElementById('ministerioFilter').value;
            
            // L贸gica de ajuste autom谩tico
            let dim1 = document.getElementById('chartDim1').value;
            let dim2 = document.getElementById('chartDim2').value;
            
            if (dim1 === "Auto") {
                if (fEje !== "Todos") dim1 = "Ministerio(s)";
                else if (fMin !== "Todos") dim1 = "Intervenci贸n";
                else dim1 = "Eje";
            }
            
            if (dim2 === "Auto") {
                if (dim1 === "Eje") dim2 = "Ministerio(s)";
                else if (dim1 === "Ministerio(s)") dim2 = "Eje";
                else dim2 = "Ninguno";
            }
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            const labelsSet = new Set();
            const conteo = {};
            
            // Procesar datos para el gr谩fico
            AppState.filteredData.forEach(row => {
                const ys = dim1 === 'Ministerio(s)' 
                    ? extraerMinisterios(row['Ministerio(s)']) 
                    : [row[dim1] || 'N/A'];
                
                const cs = dim2 === 'Ninguno' 
                    ? ['Total'] 
                    : (dim2 === 'Ministerio(s)' 
                        ? extraerMinisterios(row['Ministerio(s)']) 
                        : [row[dim2] || 'N/A']);
                
                ys.forEach(y => {
                    labelsSet.add(y);
                    cs.forEach(c => {
                        if (!conteo[c]) conteo[c] = {};
                        conteo[c][y] = (conteo[c][y] || 0) + 1;
                    });
                });
            });
            
            const sortedLabels = Array.from(labelsSet).sort();
            const datasets = Object.keys(conteo)
                .sort()
                .map((grupo, i) => ({
                    label: grupo,
                    data: sortedLabels.map(l => conteo[grupo][l] || 0),
                    backgroundColor: CONFIG.CHART_COLORS[i % CONFIG.CHART_COLORS.length],
                    borderRadius: 4,
                    barThickness: sortedLabels.length > 10 ? 15 : 25
                }));
            
            // Destruir gr谩fico anterior si existe
            if (AppState.chartInstance) {
                AppState.chartInstance.destroy();
            }
            
            // Crear nuevo gr谩fico
            AppState.chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { 
                            display: dim2 !== 'Ninguno', 
                            position: 'bottom',
                            labels: { 
                                boxWidth: 12, 
                                font: { size: 11 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 12 }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: true, 
                            grid: { display: false }, 
                            ticks: { stepSize: 1 } 
                        },
                        y: { 
                            stacked: true, 
                            ticks: { font: { size: 11 } } 
                        }
                    }
                }
            });
        }

        /**
         * Refresca el gr谩fico manualmente
         */
        function refreshChart() {
            updateChart();
            showToast('Gr谩fico actualizado', 'info');
        }

        // ============================================
        // EXPORTACIN
        // ============================================

        /**
         * Exporta los datos filtrados a Excel
         */
        function exportData() {
            try {
                if (AppState.filteredData.length === 0) {
                    showToast('No hay datos para exportar', 'warning');
                    return;
                }
                
                const ws = XLSX.utils.json_to_sheet(AppState.filteredData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Datos Filtrados");
                
                const fileName = `Reporte_Filtrado_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('Archivo exportado exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando datos:', error);
                showToast('Error al exportar datos', 'error');
            }
        }

        // ============================================
        // INICIALIZACIN
        // ============================================

        /**
         * Inicializa la aplicaci贸n
         */
        function initApp() {
            // Event listener para carga de archivo manual
            document.getElementById('excelFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const validation = validateFile(file);
                
                if (!validation.valid) {
                    showToast(validation.error, 'error');
                    e.target.value = '';
                    return;
                }
                
                toggleLoadingSpinner(true);
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                        processWorkbookData(workbook);
                        showToast('Archivo cargado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error procesando archivo:', error);
                        showToast('Error al procesar el archivo', 'error');
                    } finally {
                        toggleLoadingSpinner(false);
                    }
                };
                
                reader.onerror = () => {
                    showToast('Error al leer el archivo', 'error');
                    toggleLoadingSpinner(false);
                };
                
                reader.readAsArrayBuffer(file);
            });
            
            // Aplicar debounce a los filtros
            const filterElements = ['ejeFilter', 'ministerioFilter', 'intervencionFilter'];
            filterElements.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('change', debounce(applyFilters));
            });
            
            // Cargar archivo por defecto
            loadDefaultFile();
        }

        // Iniciar aplicaci贸n cuando el DOM est茅 listo
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>


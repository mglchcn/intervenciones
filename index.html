<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Monitoreo - Centro de Gobierno</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-dark: #1a252f;
            --accent-color: #3498db;
        }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: #f4f7f6; 
            color: #333;
        }
        
        /* Ajustes Sidebar para M贸vil */
        .sidebar { 
            background-color: var(--primary-dark);
            min-height: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        @media (min-width: 768px) {
            .sidebar { 
                position: sticky; 
                top: 0; 
                height: 100vh; 
            }
        }

        /* Estilo de Tarjetas */
        .card { 
            border: none; 
            border-radius: 12px; 
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        /* Gr谩fico Responsivo */
        .chart-container { 
            position: relative; 
            height: 60vh; /* Altura basada en el viewport para mejor ajuste */
            min-height: 400px;
            width: 100%; 
        }

        /* Tipograf铆a y Tablas */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .small-text { font-size: 0.85rem; }
        .btn-custom { border-radius: 8px; }
        
        /* Spinner centralizado */
        #loadingSpinner {
            position: fixed;
            top: 50%;
            left: 50%;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar text-white p-4">
                <div class="text-center mb-4">
                    <h5 class="fw-bold">ю Tablero CdG</h5>
                    <p class="text-muted small">Monitoreo de Gesti贸n</p>
                </div>
                <hr class="opacity-25">
                
                <div id="manualUploadContainer" class="mb-4 p-3 bg-white bg-opacity-10 rounded">
                    <label for="excelFileInput" class="form-label small fw-bold">Carga Manual:</label>
                    <input class="form-control form-control-sm" type="file" id="excelFileInput" accept=".xlsx, .xls, .csv">
                </div>

                <h6 class="text-uppercase text-muted small fw-bold mt-4 mb-3">Filtros</h6>
                <div class="mb-3">
                    <label for="ejeFilter" class="form-label small-text">Eje Estrat茅gico:</label>
                    <select id="ejeFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todos">Todos los Ejes</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="ministerioFilter" class="form-label small-text">Entidad Responsable:</label>
                    <select id="ministerioFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todos">Todas las Entidades</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="intervencionFilter" class="form-label small-text">Intervenci贸n:</label>
                    <select id="intervencionFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todas">Todas las Intervenciones</option>
                    </select>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <div class="d-flex justify-content-between align-items-center pb-3 mb-4 border-bottom">
                    <h2 class="h4 fw-bold text-dark mb-0">Visualizaci贸n de Datos</h2>
                    <div id="loadingSpinner" class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="welcomeMessage" class="alert alert-light border shadow-sm" role="alert">
                    <i class="bi bi-info-circle me-2"></i> Conectando con el repositorio de datos...
                </div>

                <div class="row g-3 mb-4" id="kpiSection" style="display: none;">
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <span class="small-text opacity-75">Intervenciones Filtradas</span>
                                <h2 id="kpi-total" class="fw-bold mb-0">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" id="chartSection" style="display: none;">
                    <div class="col-12">
                        <div class="card p-3 p-md-4">
                            <div class="row g-3 mb-4 align-items-end">
                                <div class="col-12 col-md-4">
                                    <label class="form-label small fw-bold text-secondary">Eje Vertical (Categor铆a):</label>
                                    <select id="chartDim1" class="form-select" onchange="updateChart()">
                                        <option value="Eje">Ejes</option>
                                        <option value="Ministerio(s)">Ministerios/Entidades</option>
                                        <option value="Intervenci贸n">Intervenciones</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label small fw-bold text-secondary">Agrupaci贸n por Color:</label>
                                    <select id="chartDim2" class="form-select" onchange="updateChart()">
                                        <option value="Ministerio(s)">Ministerios/Entidades</option>
                                        <option value="Eje">Ejes</option>
                                        <option value="Ninguno">Ninguno (Total)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container shadow-sm" id="tableSection" style="display: none;">
                    <h5 class="fw-bold mb-4 text-dark">Detalle de Registros</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="dataTable">
                            <thead class="table-light">
                                <tr class="small-text text-uppercase">
                                    <th>Eje</th>
                                    <th>Intervenci贸n</th>
                                    <th>Entidad Involucrada</th>
                                </tr>
                            </thead>
                            <tbody class="small-text"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let globalData = [];
        let lastFilteredData = []; 
        let chartInstance = null;

        // URL relativa para GitHub Pages
        const DEFAULT_FILE_NAME = "MATRIZ1.xlsx";

        const chartColors = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#5a5c69', '#6610f2', '#fd7e14', '#20c997', '#d63384'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadDefaultFile();
        });

        async function loadDefaultFile() {
            document.getElementById('loadingSpinner').style.display = 'block';
            try {
                const response = await fetch(DEFAULT_FILE_NAME);
                if (!response.ok) throw new Error("Acceso denegado");
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                
                processWorkbookData(workbook);
                document.getElementById('manualUploadContainer').style.display = 'none';

            } catch (error) {
                console.warn("Carga autom谩tica fallida: ", error.message);
                document.getElementById('welcomeMessage').innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <strong>Nota:</strong> No se pudo cargar autom谩ticamente el archivo. Por favor, selecciona el archivo <strong>MATRIZ1.xlsx</strong> manualmente desde el men煤 lateral.
                    </div>
                `;
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        document.getElementById('excelFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('loadingSpinner').style.display = 'block';
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    processWorkbookData(workbook);
                    document.getElementById('loadingSpinner').style.display = 'none';
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function processWorkbookData(workbook) {
            let sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('proceso'));
            if (!sheetName) sheetName = workbook.SheetNames[0];

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 3, defval: "" });

            globalData = jsonData.filter(row => row['Eje'] && row['Eje'].toString().trim() !== '');

            if(globalData.length === 0) {
                alert("La matriz est谩 vac铆a o tiene un formato incorrecto.");
                return;
            }

            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('kpiSection').style.display = 'flex';
            document.getElementById('chartSection').style.display = 'flex';
            document.getElementById('tableSection').style.display = 'block';

            populateFilters();
            applyFilters();
        }

        function extraerMinisterios(cadena) {
            if (!cadena) return [];
            return cadena.toString().split(/[;/,]/).map(item => item.trim()).filter(item => item !== "");
        }

        function populateFilters() {
            const ejeSet = new Set();
            const minSet = new Set();
            const intSet = new Set();

            globalData.forEach(row => {
                if (row['Eje']) ejeSet.add(row['Eje']);
                if (row['Intervenci贸n']) intSet.add(row['Intervenci贸n']);
                if (row['Ministerio(s)']) {
                    const ministerios = extraerMinisterios(row['Ministerio(s)']);
                    ministerios.forEach(min => minSet.add(min));
                }
            });

            const populate = (id, items, defaultText) => {
                const el = document.getElementById(id);
                el.innerHTML = `<option value="Todos">${defaultText}</option>`;
                Array.from(items).sort().forEach(val => el.add(new Option(val, val)));
            };

            populate('ejeFilter', ejeSet, 'Todos los Ejes');
            populate('ministerioFilter', minSet, 'Todas las Entidades');
            
            const intSelect = document.getElementById('intervencionFilter');
            intSelect.innerHTML = '<option value="Todas">Todas las Intervenciones</option>';
            Array.from(intSet).sort().forEach(intv => intSelect.add(new Option(intv, intv)));
        }

        function applyFilters() {
            const ejeSelected = document.getElementById('ejeFilter').value;
            const minSelected = document.getElementById('ministerioFilter').value;
            const intSelected = document.getElementById('intervencionFilter').value;

            lastFilteredData = globalData.filter(row => {
                const matchEje = ejeSelected === 'Todos' || row['Eje'] === ejeSelected;
                const matchInt = intSelected === 'Todas' || row['Intervenci贸n'] === intSelected;
                let matchMin = (minSelected === 'Todos') || (row['Ministerio(s)'] && extraerMinisterios(row['Ministerio(s)']).includes(minSelected));
                return matchEje && matchMin && matchInt;
            });

            document.getElementById('kpi-total').innerText = lastFilteredData.length;
            updateTable();
            updateChart();
        }

        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            lastFilteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-medium">${row['Eje'] || '-'}</td>
                    <td>${row['Intervenci贸n'] || '-'}</td>
                    <td class="text-secondary small">${row['Ministerio(s)'] || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateChart() {
            if (!lastFilteredData.length) return;

            const ctx = document.getElementById('mainChart').getContext('2d');
            const dim1 = document.getElementById('chartDim1').value; 
            const dim2 = document.getElementById('chartDim2').value; 

            let labelsSet = new Set();
            let conteo = {}; 

            lastFilteredData.forEach(row => {
                const valsY = (dim1 === 'Ministerio(s)') ? extraerMinisterios(row['Ministerio(s)']) : [row[dim1] || 'Sin Dato'];
                const valsC = (dim2 === 'Ninguno') ? ['Total'] : (dim2 === 'Ministerio(s)') ? extraerMinisterios(row['Ministerio(s)']) : [row[dim2] || 'Sin Dato'];

                valsY.forEach(y => {
                    labelsSet.add(y);
                    valsC.forEach(c => {
                        if (!conteo[c]) conteo[c] = {};
                        conteo[c][y] = (conteo[c][y] || 0) + 1;
                    });
                });
            });

            const labelsY = Array.from(labelsSet).sort();
            const datasets = Object.keys(conteo).sort().map((grupo, i) => ({
                label: grupo,
                data: labelsY.map(l => conteo[grupo][l] || 0),
                backgroundColor: chartColors[i % chartColors.length],
                borderRadius: 4
            }));

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labelsY, datasets: datasets },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: dim2 !== 'Ninguno', position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true }
                    }
                }
            });
        }
    </script>
</body>
</html>

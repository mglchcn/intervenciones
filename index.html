<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Monitoreo - Centro de Gobierno</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* === ESTILOS BASE === */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f8f9fa; 
        }
        
        /* === BARRA LATERAL (SIDEBAR) === */
        .sidebar { 
            box-shadow: inset -1px 0 0 rgba(0,0,0,.1); 
        }
        
        /* Comportamiento en Monitores (Desktop) */
        @media (min-width: 768px) {
            .sidebar { 
                position: sticky; 
                top: 0; 
                height: 100vh; 
                overflow-y: auto;
            }
        }

        /* === COMPONENTES UI === */
        .card { 
            border: none; 
            border-radius: 10px; 
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .table th { 
            white-space: nowrap; 
        }
        
        /* === GRFICOS (RESPONSIVOS) === */
        .chart-container { 
            position: relative; 
            width: 100%; 
        }
        
        @media (max-width: 767px) {
            .chart-container { height: 350px; } /* Altura reducida para m贸viles */
        }
        @media (min-width: 768px) {
            .chart-container { height: 500px; } /* Altura completa para PC */
        }

        /* Animaci贸n de carga */
        #loadingSpinner { display: none; }
    </style>
</head>
<body>
    <header class="navbar navbar-dark bg-dark sticky-top d-md-none flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="#">ю Tablero CdG</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation" style="right: 15px; top: 10px;">
            <span class="navbar-toggler-icon"></span>
        </button>
    </header>

    <div class="container-fluid">
        <div class="row">
            
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse text-white p-3">
                <h4 class="text-center mb-4 d-none d-md-block pt-3">ю Tablero CdG</h4>
                <hr class="d-none d-md-block">
                
                <div class="mb-4 p-3 bg-secondary bg-opacity-25 rounded border border-secondary" id="manualUploadContainer">
                    <label for="excelFileInput" class="form-label text-white small fw-bold">Carga Manual (Opcional):</label>
                    <input class="form-control form-control-sm" type="file" id="excelFileInput" accept=".xlsx, .xls, .csv">
                </div>

                <h6 class="text-uppercase text-muted mt-4 mb-3 fw-bold">Filtros de Datos</h6>
                
                <div class="mb-3">
                    <label for="ejeFilter" class="form-label small mb-1">Eje:</label>
                    <select id="ejeFilter" class="form-select form-select-sm shadow-sm" onchange="applyFilters()">
                        <option value="Todos">Todos los Ejes</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="ministerioFilter" class="form-label small mb-1">Entidad/Ministerio:</label>
                    <select id="ministerioFilter" class="form-select form-select-sm shadow-sm" onchange="applyFilters()">
                        <option value="Todos">Todas las Entidades</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="intervencionFilter" class="form-label small mb-1">Intervenci贸n:</label>
                    <select id="intervencionFilter" class="form-select form-select-sm shadow-sm" onchange="applyFilters()">
                        <option value="Todas">Todas las Intervenciones</option>
                    </select>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 bg-light min-vh-100">
                
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
                    <h1 class="h2 fw-bold text-dark">Distribuci贸n de Intervenciones</h1>
                    <div id="loadingSpinner" class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="welcomeMessage" class="alert alert-info shadow-sm border-0 border-start border-5 border-info" role="alert">
                    Intentando cargar la matriz de indicadores autom谩ticamente... Si no sucede nada, utiliza el bot贸n de carga manual en el men煤 lateral.
                </div>

                <div class="row mb-4" id="kpiSection" style="display: none;">
                    <div class="col-12 col-md-6 col-xl-4">
                        <div class="card text-white bg-primary shadow-sm h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h6 class="card-title mb-1 opacity-75">Total Intervenciones Filtradas</h6>
                                <h2 id="kpi-total" class="mb-0 fw-bold display-6">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4" id="chartSection" style="display: none;">
                    <div class="col-12 bg-white p-4 rounded shadow-sm">
                        
                        <div class="row mb-4 pb-3 border-bottom g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label small fw-bold text-primary mb-1">Mostrar en el Eje Vertical:</label>
                                <select id="chartDim1" class="form-select form-select-sm" onchange="updateChart()">
                                    <option value="Eje">Ejes</option>
                                    <option value="Ministerio(s)">Ministerios/Entidades</option>
                                    <option value="Intervenci贸n">Intervenciones</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small fw-bold text-success mb-1">Agrupar por Colores:</label>
                                <select id="chartDim2" class="form-select form-select-sm" onchange="updateChart()">
                                    <option value="Ministerio(s)">Ministerios/Entidades</option>
                                    <option value="Eje">Ejes</option>
                                    <option value="Ninguno">Ninguno (Total Unificado)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded shadow-sm" id="tableSection" style="display: none;">
                    <h5 class="fw-bold mb-3 text-secondary">Detalle de Intervenciones</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered border-light align-middle" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Eje</th>
                                    <th scope="col">Intervenci贸n</th>
                                    <th scope="col">Entidad(es) Involucrada(s)</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
                
            </main>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIN Y VARIABLES GLOBALES ---
        let globalData = [];
        let lastFilteredData = []; 
        let chartInstance = null;

        // Se usa ruta relativa expl铆cita (./) para GitHub Pages
        const DEFAULT_FILE_NAME = "./MATRIZ1.xlsx";
        
        const chartColors = [
            '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1',
            '#fd7e14', '#0dcaf0', '#20c997', '#d63384', '#6610f2',
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
        ];

        // --- 2. INICIALIZACIN Y CARGA DE DATOS ---
        document.addEventListener('DOMContentLoaded', loadDefaultFile);

        async function loadDefaultFile() {
            toggleLoader(true);
            try {
                // TCNICA CACHE-BUSTER: Agrega un par谩metro de tiempo para que GitHub Pages
                // siempre entregue la 煤ltima versi贸n del archivo y evite errores 404 oxidados.
                const url = DEFAULT_FILE_NAME + "?v=" + new Date().getTime();
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                
                processWorkbookData(workbook);
                document.getElementById('manualUploadContainer').style.display = 'none';

            } catch (error) {
                console.warn("Error al cargar archivo autom谩ticamente. Detalles:", error);
                document.getElementById('welcomeMessage').innerHTML = `
                    No se pudo cargar <strong>MATRIZ1.xlsx</strong> autom谩ticamente. <br>
                    <span class="text-danger small">(Error: ${error.message})</span><br>
                    <strong>Por favor, utiliza el bot贸n "Carga Manual" en el men煤 lateral.</strong>
                `;
            } finally {
                toggleLoader(false);
            }
        }

        document.getElementById('excelFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            toggleLoader(true);
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                processWorkbookData(workbook);
                toggleLoader(false);
            };
            reader.readAsArrayBuffer(file);
        });

        // --- 3. PROCESAMIENTO CENTRALIZADO ---
        function processWorkbookData(workbook) {
            let sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('proceso')) || workbook.SheetNames[0];
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { range: 3, defval: "" });

            globalData = jsonData.filter(row => row['Eje'] && row['Eje'].toString().trim() !== '');

            if(globalData.length === 0) {
                alert("No se encontraron datos v谩lidos. Verifica la estructura de la Matriz.");
                return;
            }

            // Revelar la interfaz
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('kpiSection').style.display = 'flex';
            document.getElementById('chartSection').style.display = 'flex';
            document.getElementById('tableSection').style.display = 'block';

            populateFilters();
            applyFilters();
        }

        // --- 4. UTILIDADES Y FILTROS ---
        function extraerMinisterios(cadena) {
            if (!cadena) return [];
            return cadena.toString().split(/[;/]/).map(item => item.trim()).filter(item => item !== "");
        }

        function populateFilters() {
            const ejes = new Set(), ministerios = new Set(), intervenciones = new Set();

            globalData.forEach(row => {
                if (row['Eje']) ejes.add(row['Eje']);
                if (row['Intervenci贸n']) intervenciones.add(row['Intervenci贸n']);
                if (row['Ministerio(s)']) {
                    extraerMinisterios(row['Ministerio(s)']).forEach(min => ministerios.add(min));
                }
            });

            fillSelect('ejeFilter', ejes, 'Todos los Ejes');
            fillSelect('ministerioFilter', ministerios, 'Todas las Entidades');
            fillSelect('intervencionFilter', intervenciones, 'Todas las Intervenciones');
        }

        function fillSelect(elementId, dataSet, defaultText) {
            const select = document.getElementById(elementId);
            select.innerHTML = `<option value="Todos">${defaultText}</option>`;
            Array.from(dataSet).sort().forEach(item => select.add(new Option(item, item)));
        }

        function applyFilters() {
            const ejeSel = document.getElementById('ejeFilter').value;
            const minSel = document.getElementById('ministerioFilter').value;
            const intSel = document.getElementById('intervencionFilter').value;

            lastFilteredData = globalData.filter(row => {
                const matchEje = ejeSel === 'Todos' || row['Eje'] === ejeSel;
                const matchInt = intSel === 'Todas' || row['Intervenci贸n'] === intSel;
                
                const mins = row['Ministerio(s)'] ? extraerMinisterios(row['Ministerio(s)']) : [];
                const matchMin = minSel === 'Todos' || mins.includes(minSel);

                return matchEje && matchMin && matchInt;
            });

            document.getElementById('kpi-total').innerText = lastFilteredData.length;
            updateTable();
            updateChart();
        }

        // --- 5. RENDERIZADO VISUAL (TABLAS Y GRFICOS) ---
        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            lastFilteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-medium text-dark">${row['Eje'] || '-'}</td>
                    <td>${row['Intervenci贸n'] || '-'}</td>
                    <td class="text-muted">${row['Ministerio(s)'] || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getDimValues(row, dimension) {
            if (dimension === 'Ninguno') return ['Total'];
            if (dimension === 'Ministerio(s)') return extraerMinisterios(row['Ministerio(s)']);
            return row[dimension] ? [row[dimension].toString().trim()] : [`Sin ${dimension}`];
        }

        function updateChart() {
            if (!lastFilteredData || lastFilteredData.length === 0) return;

            const ctx = document.getElementById('mainChart').getContext('2d');
            const dim1 = document.getElementById('chartDim1').value; 
            const dim2 = document.getElementById('chartDim2').value; 

            const labelsSet = new Set();
            const conteo = {}; 

            // Agrupar datos seg煤n selecciones
            lastFilteredData.forEach(row => {
                const valYArray = getDimValues(row, dim1);
                let valColorArray = getDimValues(row, dim2);
                if (valColorArray.length === 0) valColorArray = ["No definido"];

                valYArray.forEach(valY => {
                    labelsSet.add(valY);
                    valColorArray.forEach(valColor => {
                        if (!conteo[valColor]) conteo[valColor] = {};
                        conteo[valColor][valY] = (conteo[valColor][valY] || 0) + 1;
                    });
                });
            });

            const labelsY = Array.from(labelsSet).sort();
            const datasets = Object.keys(conteo).sort().map((grupo, index) => ({
                label: grupo,
                data: labelsY.map(label => conteo[grupo][label] || 0),
                backgroundColor: chartColors[index % chartColors.length],
                borderWidth: 1,
                borderRadius: 4 
            }));

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labelsY, datasets: datasets },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { position: 'top', display: (dim2 !== 'Ninguno') },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } },
                        y: { stacked: true }
                    }
                }
            });
        }

        function toggleLoader(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'inline-block' : 'none';
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Monitoreo - Centro de Gobierno</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-dark: #1a252f;
            --accent-color: #3498db;
        }
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: #f4f7f6; 
            color: #333;
        }
        .sidebar { 
            background-color: var(--primary-dark);
            min-height: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        @media (min-width: 768px) {
            .sidebar { position: sticky; top: 0; height: 100vh; }
        }
        .card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .chart-container { 
            position: relative; 
            height: 65vh; 
            min-height: 450px;
            width: 100%; 
        }
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .small-text { font-size: 0.85rem; }
        #loadingSpinner {
            position: fixed;
            top: 50%;
            left: 50%;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar text-white p-4">
                <div class="text-center mb-4">
                    <h5 class="fw-bold">ю Tablero CdG</h5>
                    <p class="text-muted small">Monitoreo de Gesti贸n</p>
                </div>
                <hr class="opacity-25">
                
                <div id="manualUploadContainer" class="mb-4 p-3 bg-white bg-opacity-10 rounded">
                    <label for="excelFileInput" class="form-label small fw-bold">Carga Manual:</label>
                    <input class="form-control form-control-sm" type="file" id="excelFileInput" accept=".xlsx, .xls, .csv">
                </div>

                <h6 class="text-uppercase text-muted small fw-bold mt-4 mb-3">Filtros Activos</h6>
                <div class="mb-3">
                    <label for="ejeFilter" class="form-label small-text">Filtrar por Eje:</label>
                    <select id="ejeFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todos">Todos los Ejes</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="ministerioFilter" class="form-label small-text">Filtrar por Entidad:</label>
                    <select id="ministerioFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todos">Todas las Entidades</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="intervencionFilter" class="form-label small-text">Intervenci贸n Espec铆fica:</label>
                    <select id="intervencionFilter" class="form-select form-select-sm" onchange="applyFilters()">
                        <option value="Todas">Todas las Intervenciones</option>
                    </select>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <div class="d-flex justify-content-between align-items-center pb-3 mb-4 border-bottom">
                    <h2 class="h4 fw-bold text-dark mb-0">Distribuci贸n de Intervenciones</h2>
                    <div id="loadingSpinner" class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="welcomeMessage" class="alert alert-light border shadow-sm" role="alert">
                    Intentando conectar con MATRIZ1.xlsx...
                </div>

                <div class="row g-3 mb-4" id="kpiSection" style="display: none;">
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <span class="small-text opacity-75">Resultados bajo filtros</span>
                                <h2 id="kpi-total" class="fw-bold mb-0">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" id="chartSection" style="display: none;">
                    <div class="col-12">
                        <div class="card p-3 p-md-4">
                            <div class="row g-3 mb-4 align-items-end">
                                <div class="col-12 col-md-5">
                                    <label class="form-label small fw-bold text-secondary">Ver en el Eje Y:</label>
                                    <select id="chartDim1" class="form-select" onchange="updateChart()">
                                        <option value="Auto">Auto (Ajuste seg煤n Filtro)</option>
                                        <option value="Eje">Ejes Estrat茅gicos</option>
                                        <option value="Ministerio(s)">Entidades/Ministerios</option>
                                        <option value="Intervenci贸n">Nombre de Intervenci贸n</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-5">
                                    <label class="form-label small fw-bold text-secondary">Colores por:</label>
                                    <select id="chartDim2" class="form-select" onchange="updateChart()">
                                        <option value="Auto">Auto (Ajuste seg煤n Filtro)</option>
                                        <option value="Ministerio(s)">Entidades</option>
                                        <option value="Eje">Ejes</option>
                                        <option value="Ninguno">Unificado (Sin agrupaci贸n)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container shadow-sm" id="tableSection" style="display: none;">
                    <h5 class="fw-bold mb-4 text-dark">Detalle de Registros Filtrados</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="dataTable">
                            <thead class="table-light">
                                <tr class="small-text text-uppercase">
                                    <th>Eje</th>
                                    <th>Intervenci贸n</th>
                                    <th>Entidad</th>
                                </tr>
                            </thead>
                            <tbody class="small-text"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let globalData = [];
        let lastFilteredData = []; 
        let chartInstance = null;
        const DEFAULT_FILE_NAME = "MATRIZ1.xlsx";
        const chartColors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6610f2', '#fd7e14', '#20c997', '#d63384'];

        document.addEventListener('DOMContentLoaded', loadDefaultFile);

        async function loadDefaultFile() {
            try {
                const response = await fetch(DEFAULT_FILE_NAME);
                if (!response.ok) throw new Error();
                const arrayBuffer = await response.arrayBuffer();
                processWorkbookData(XLSX.read(new Uint8Array(arrayBuffer), {type: 'array'}));
                document.getElementById('manualUploadContainer').style.display = 'none';
            } catch (e) {
                document.getElementById('welcomeMessage').innerHTML = `<div class="alert alert-warning mb-0 small">Carga autom谩tica no disponible. Por favor, sube el archivo manualmente.</div>`;
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                processWorkbookData(XLSX.read(new Uint8Array(event.target.result), {type: 'array'}));
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function processWorkbookData(workbook) {
            let sheet = workbook.Sheets[workbook.SheetNames.find(n => n.toLowerCase().includes('proceso')) || workbook.SheetNames[0]];
            globalData = XLSX.utils.sheet_to_json(sheet, { range: 3, defval: "" })
                             .filter(row => row['Eje'] && row['Eje'].toString().trim() !== '');

            document.getElementById('welcomeMessage').style.display = 'none';
            document.querySelectorAll('#kpiSection, #chartSection, #tableSection').forEach(el => el.style.display = 'flex');
            if(window.innerWidth < 768) document.getElementById('tableSection').style.display = 'block';

            populateFilters();
            applyFilters();
        }

        function extraerMinisterios(cadena) {
            return cadena ? cadena.toString().split(/[;/,]/).map(i => i.trim()).filter(i => i !== "") : [];
        }

        function populateFilters() {
            const sets = { eje: new Set(), min: new Set(), int: new Set() };
            globalData.forEach(row => {
                sets.eje.add(row['Eje']);
                sets.int.add(row['Intervenci贸n']);
                extraerMinisterios(row['Ministerio(s)']).forEach(m => sets.min.add(m));
            });

            const fill = (id, set, def) => {
                const el = document.getElementById(id);
                el.innerHTML = `<option value="${id === 'intervencionFilter' ? 'Todas' : 'Todos'}">${def}</option>`;
                Array.from(set).sort().forEach(v => el.add(new Option(v, v)));
            };

            fill('ejeFilter', sets.eje, 'Todos los Ejes');
            fill('ministerioFilter', sets.min, 'Todas las Entidades');
            fill('intervencionFilter', sets.int, 'Todas las Intervenciones');
        }

        function applyFilters() {
            const fEje = document.getElementById('ejeFilter').value;
            const fMin = document.getElementById('ministerioFilter').value;
            const fInt = document.getElementById('intervencionFilter').value;

            lastFilteredData = globalData.filter(row => {
                const mEje = fEje === 'Todos' || row['Eje'] === fEje;
                const mInt = fInt === 'Todas' || row['Intervenci贸n'] === fInt;
                const mMin = fMin === 'Todos' || extraerMinisterios(row['Ministerio(s)']).includes(fMin);
                return mEje && mInt && mMin;
            });

            document.getElementById('kpi-total').innerText = lastFilteredData.length;
            updateTable();
            updateChart();
        }

        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = lastFilteredData.map(row => `
                <tr>
                    <td class="fw-medium">${row['Eje']}</td>
                    <td>${row['Intervenci贸n']}</td>
                    <td class="text-secondary small">${row['Ministerio(s)']}</td>
                </tr>
            `).join('');
        }

        function updateChart() {
            if (!lastFilteredData.length) return;

            const fEje = document.getElementById('ejeFilter').value;
            const fMin = document.getElementById('ministerioFilter').value;
            
            // L贸gica de "Auto" ajuste
            let dim1 = document.getElementById('chartDim1').value;
            let dim2 = document.getElementById('chartDim2').value;

            if (dim1 === "Auto") {
                // Si filtramos por Eje, mostramos Ministerios en el gr谩fico.
                // Si filtramos por Ministerio, mostramos Intervenciones.
                if (fEje !== "Todos") dim1 = "Ministerio(s)";
                else if (fMin !== "Todos") dim1 = "Intervenci贸n";
                else dim1 = "Eje";
            }

            if (dim2 === "Auto") {
                if (dim1 === "Eje") dim2 = "Ministerio(s)";
                else if (dim1 === "Ministerio(s)") dim2 = "Eje";
                else dim2 = "Ninguno";
            }

            const ctx = document.getElementById('mainChart').getContext('2d');
            let labelsSet = new Set();
            let conteo = {}; 

            lastFilteredData.forEach(row => {
                const ys = (dim1 === 'Ministerio(s)') ? extraerMinisterios(row['Ministerio(s)']) : [row[dim1] || 'N/A'];
                const cs = (dim2 === 'Ninguno') ? ['Total'] : (dim2 === 'Ministerio(s)') ? extraerMinisterios(row['Ministerio(s)']) : [row[dim2] || 'N/A'];

                ys.forEach(y => {
                    labelsSet.add(y);
                    cs.forEach(c => {
                        if (!conteo[c]) conteo[c] = {};
                        conteo[c][y] = (conteo[c][y] || 0) + 1;
                    });
                });
            });

            const sortedLabels = Array.from(labelsSet).sort();
            const datasets = Object.keys(conteo).sort().map((grupo, i) => ({
                label: grupo,
                data: sortedLabels.map(l => conteo[grupo][l] || 0),
                backgroundColor: chartColors[i % chartColors.length],
                borderRadius: 4,
                barThickness: sortedLabels.length > 10 ? 15 : 25
            }));

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: sortedLabels, datasets },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: dim2 !== 'Ninguno', 
                            position: 'bottom',
                            labels: { boxWidth: 10, font: { size: 10 } }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { stepSize: 1 } },
                        y: { stacked: true, ticks: { font: { size: 11 } } }
                    }
                }
            });
        }
    </script>
</body>
</html>
